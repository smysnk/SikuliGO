# CI Test Reporting

This document defines how SikuliGO publishes test execution and coverage in GitHub Actions.

## Workflow

- Workflow file: `.github/workflows/go-test.yml`
- Triggered on:
  - `push` to `main` for Go and docs changes
  - `pull_request` for Go and docs changes
  - manual `workflow_dispatch`

## Published test outputs

The workflow writes all outputs into `.test-results/` and uploads them as the `go-test-results` artifact.

- `junit.xml`: JUnit report generated by `gotestsum` for GitHub check-style reporting.
- `go-test.json`: machine-readable Go test event stream from `gotestsum`.
- `coverage.out`: raw Go coverage profile.
- `coverage.txt`: human-readable function coverage from `go tool cover -func`.
- `summary.json`: aggregated package/test summary used for webhook publishing.

## GitHub-friendly visibility

- Test report publication:
  - Uses `dorny/test-reporter` with JUnit input.
  - Automatically skipped for forked pull requests where check-write permissions are unavailable.
- Job summary:
  - Posts total coverage and full function coverage output to `$GITHUB_STEP_SUMMARY`.
  - Posts an OCR-focused test summary block from `go-test.json`.
- Artifact upload:
  - Uploads all `.test-results/` files for download and downstream tooling.
- Webhook publish:
  - Runs `scripts/publish-test-results.mjs` on pushes to `main` using `DISCORD_TEST_WEBHOOK_URL` (or `DISCORD_WEBHOOK_URL`) when configured.
- Coverage gate:
  - Fails the test job when total coverage drops below the configured threshold (`COVERAGE_MIN_PERCENT`, default `65`).
- Optional OCR tagged job:
  - Runs `go test -tags gogosseract ./internal/ocr ./pkg/sikuli` in a non-blocking (`continue-on-error`) job.
- Parity end-to-end job:
  - Runs cross-protocol parity flows in `pkg/sikuli` for default and `-tags gogosseract` builds.
  - Publishes dedicated JUnit checks (`GoLang Parity E2E`) and uploads `.test-results-e2e/` as `go-parity-e2e-results`.

## Local parity command

To run the same validation gates locally:

```bash
go mod tidy
go vet ./...
go test -race -covermode=atomic -coverprofile=coverage.out ./...
go tool cover -func=coverage.out
go test -run '^TestCrossProtocolIntegrationFlow$' ./pkg/sikuli
go test -tags gogosseract -run '^TestCrossProtocolIntegrationFlowTaggedOCR$' ./pkg/sikuli
```
